# 商家认证系统说明

## 概述

本系统为银家家购物平台提供商家端的注册和登录功能，支持手机号+密码的认证方式。

## 功能特性

### 1. 商家注册
- **接口**: `POST /api/web/auth/register`
- **参数**: 
  - `phone`: 手机号（必填，唯一）
  - `password`: 密码（必填，最少6位）
- **功能**: 
  - 验证手机号唯一性
  - 自动生成全局唯一商家编号
  - 密码使用base64编码存储（演示用，生产环境请使用强哈希）

### 2. 商家登录
- **接口**: `POST /api/web/auth/login`
- **参数**: 
  - `phone`: 手机号
  - `password`: 密码
- **返回**: 
  - 登录成功返回token和商家信息
  - token有效期7天

### 3. Token验证
- **接口**: `GET /api/web/auth/validate?token=xxx`
- **功能**: 验证token是否有效

### 4. 获取商家信息
- **接口**: `GET /api/web/auth/profile?token=xxx`
- **功能**: 获取当前登录商家的详细信息

## 数据库变更

### 新增字段
- `merchants.password`: 密码字段（VARCHAR(128)）
- `merchants.status`: 状态字段（VARCHAR(16)，默认'active'）

### 约束变更
- `merchants.phone`: 添加唯一约束

## 部署步骤

### 1. 数据库迁移
```bash
# 执行SQL脚本
mysql -u username -p database_name < scripts/sql/add_merchant_password.sql
```

### 2. 重启后端服务
```bash
cd app/backend
python app.py
```

### 3. 前端访问
- 商家注册页面: `/register`
- 商家登录页面: `/login`

## 测试

### 运行测试脚本
```bash
python test_merchant_auth.py
```

### 测试用例
1. 商家注册（手机号: 13800138000, 密码: 123456）
2. 商家登录
3. Token验证
4. 获取商家信息

## 安全说明

### 当前实现（演示用）
- 密码使用base64编码存储
- Token使用简单的base64编码

### 生产环境建议
- 使用bcrypt或Argon2等强哈希算法
- 实现JWT标准token
- 添加密码复杂度验证
- 实现登录失败次数限制
- 添加手机号验证码验证

## API响应格式

### 成功响应
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    // 具体数据
  }
}
```

### 错误响应
```json
{
  "code": 400,
  "message": "错误描述"
}
```

## 前端集成

### 登录成功后
```javascript
// 保存token和商家信息
localStorage.setItem('merchant_token', result.data.token)
localStorage.setItem('merchant_info', JSON.stringify({
  merchant_id: result.data.merchant_id,
  merchant_number: result.data.merchant_number,
  phone: result.data.phone
}))

// 跳转到商家后台
router.push('/dashboard')
```

### 请求头设置
```javascript
// 在需要认证的请求中添加token
headers: {
  'Authorization': `Bearer ${localStorage.getItem('merchant_token')}`
}
```

## 注意事项

1. 首次部署需要执行数据库迁移脚本
2. 确保后端服务正常运行
3. 前端页面已更新为商家端专用
4. 测试时注意清理测试数据
5. 生产环境部署前请修改安全相关配置
